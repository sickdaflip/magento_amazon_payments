var AmazonPayments=function(selectorFn,serializer){var _extendObj=function(e,t){for(var o in t)e[o]=t[o];return this},_xhrCall=function(e,t,o,n,r,a){var c=new XMLHttpRequest;c.onreadystatechange=function(){switch(c.readyState){case XMLHttpRequest.OPENED:r&&r();break;case XMLHttpRequest.DONE:200===c.status?o&&o(c.responseText):n&&n(c),a&&a()}},c.open("post",e,!0),c.setRequestHeader("Content-type","application/x-www-form-urlencoded"),c.send(t)},_getElementsBySelector=function(e){return selectorFn(e)},_getElementById=function(e){var t=_getElementsBySelector("#"+e);return t.length?t[0]:null},_getElementByName=function(e){var t=_getElementsBySelector(e);return t.length?t[0]:null},_evalJsScripts=function(html){for(var scripts=html.getElementsByTagName("script"),i=0;i<scripts.length;i++)try{eval(scripts[i].innerHTML)}catch(err){}},_serializeForm=function(){var e=[];checkoutOrderReferenceId&&e.push("orderReferenceId="+checkoutOrderReferenceId);for(var t=0;t<arguments.length;t++){var o=_getElementById(arguments[t]);o&&e.push(serializer(o))}return e.join("&")},_setLoadWaiting=function(){for(var e=0;e<arguments.length;e++){var t=_getElementById(arguments[e]);if(t){var o=t.up("li");o&&o.addClassName("loading")}}},_unsetLoadWaiting=function(){for(var e=0;e<arguments.length;e++){var t=_getElementById(arguments[e]);if(t){var o=t.up("li");o&&o.removeClassName("loading")}}},_setFormLoadWaiting=function(){var e=_getElementById(config.pleaseWaitId);e&&e.show(),_showOverlay()},_unsetFormLoadWaiting=function(){var e=_getElementById(config.pleaseWaitId);e&&e.hide(),_hideOverlay()},_showOverlay=function(){var e=_getElementByName("body");e.insert('<div class="amazon-widget-overlay" id="'+config.amazonPleaseWaitOverlayId+'"></div>')},_hideOverlay=function(){var e=_getElementById(config.amazonPleaseWaitOverlayId);e&&e.remove()},config={live:!0,popup:!0,virtual:!1,pay:{selector:null,callbackUrl:null,design:null},login:{selector:null,callbackUrl:null,design:null},checkoutUrl:null,addToCartUrl:null,currency:null,debug:!1,scope:"profile payments:widget payments:shipping_address payments:billing_address",addToCartFormId:"product_addtocart_form",shippingMethodFormId:"co-shipping-method-form",discountCouponFormId:"discount-coupon-form",checkoutAgreementsFormId:"checkout-agreements",checkoutSubmitButtonId:"amazonpayments-checkout-place-order-button",simulationFormId:"sandbox-simulation",customFieldsFormId:"amazonpayments-custom-fields",pleaseWaitId:"review-please-wait",amazonPleaseWaitOverlayId:"amazon-please-wait-overlay"},checkoutParams={responsive:!0,addressBook:"addressBookWidgetDiv",wallet:"walletWidgetDiv",shippingMethod:"shippingMethodWidgetDiv",review:"reviewWidgetDiv",urls:{}},checkoutOrderReferenceId=null,checkoutSubmitAllowed=!1,checkoutPaymentSelected=!1,checkoutShippingAddressSelected=!1,addressBookWidget=null,walletWidget=null,errorCodes={clearOrderReference:["InvalidOrderReferenceId"],cancelOrderReference:[],redirect:["BuyerNotAssociated","BuyerSessionExpired","StaleOrderReference"]},_addressSelectCallback=function(){_setCheckoutPaymentSelected(!1),customCallbacks.onShippingAddressSelectStart&&customCallbacks.onShippingAddressSelectStart(),_xhrCall(checkoutParams.urls.saveShipping,_serializeForm(),function(e){callbacks.onXhrSuccess(e),customCallbacks.onShippingAddressSelectSuccess&&customCallbacks.onShippingAddressSelectSuccess()},function(e){callbacks.onXhrError(e),customCallbacks.onShippingAddressSelectError&&customCallbacks.onShippingAddressSelectError()},function(){_setLoadWaiting(checkoutParams.shippingMethod,checkoutParams.review)},function(){_unsetLoadWaiting(checkoutParams.shippingMethod,checkoutParams.review)}),_setCheckoutShippingAddressSelected(!0)},_orderReferenceCreateCallback=function(e){checkoutOrderReferenceId||(setOrderReferenceId(e.getAmazonOrderReferenceId()),config.virtual||_renderWalletWidget())},_paymentSelectCallback=function(){_setCheckoutPaymentSelected(!0)},_shippingMethodSelectCallback=function(){_xhrCall(checkoutParams.urls.saveShippingMethod,_serializeForm(config.shippingMethodFormId),callbacks.onXhrSuccess,callbacks.onXhrError,function(){_setLoadWaiting(checkoutParams.review)},function(){_unsetLoadWaiting(checkoutParams.review)})},_authorizationCallback=function(e){e?config.popup?amazon.Login.authorize({scope:config.scope,popup:config.popup},function(e){return e.error?void alert(e.error):void(e.access_token&&_xhrCall(config.addToCartUrl,_serializeForm(config.addToCartFormId),function(t){return t=JSON.parse(t),t.error?void _handleXhrErrorResponse(t):void(t.success&&(window.location.href=config.pay.callbackUrl+"?access_token="+e.access_token))},callbacks.onXhrError,_showOverlay,_hideOverlay))}):_xhrCall(config.addToCartUrl,_serializeForm(config.addToCartFormId),function(e){return e=JSON.parse(e),e.error?void _handleXhrErrorResponse(e):void(e.success&&amazon.Login.authorize({scope:config.scope,popup:config.popup},config.pay.callbackUrl))},callbacks.onXhrError,_showOverlay,_hideOverlay):amazon.Login.authorize({scope:config.scope,popup:config.popup},config.pay.callbackUrl)},_signInCallback=function(e){var t=document.createElement("input");t.setAttribute("type","hidden"),t.setAttribute("name","orderReferenceId"),t.setAttribute("value",e.getAmazonOrderReferenceId());var o=document.createElement("form");o.setAttribute("method","post"),o.setAttribute("action",config.checkoutUrl),o.appendChild(t),document.body.appendChild(o),o.submit()},_widgetErrorCallback=function(e){var t=checkoutParams;config.debug&&alert("["+e.getErrorCode()+"]: "+e.getErrorMessage()),errorCodes.clearOrderReference.some(function(t){return t===e.getErrorCode()})&&(window.location.href=t.urls.clearOrderReference||t.urls.failure),errorCodes.cancelOrderReference.some(function(t){return t===e.getErrorCode()})&&(window.location.href=t.urls.cancelOrderReference||t.urls.failure),errorCodes.redirect.some(function(t){return t===e.getErrorCode()})&&(window.location.href=t.urls.failure)},_xhrErrorCallback=function(e){config.debug&&alert(e.statusText),e.getResponseHeader("Login-Required")&&checkoutParams.urls.failure&&(window.location.href=checkoutParams.urls.failure)},_xhrSuccessCallback=function(e){_handleXhrResponse(e)},callbacks={authorization:_authorizationCallback,onAddressSelect:_addressSelectCallback,onButtonError:_widgetErrorCallback,onOrderReferenceCreate:_orderReferenceCreateCallback,onPaymentSelect:_paymentSelectCallback,onShippingMethodSelect:_shippingMethodSelectCallback,onSignIn:_signInCallback,onWidgetError:_widgetErrorCallback,onXhrError:_xhrErrorCallback,onXhrSuccess:_xhrSuccessCallback},customCallbacks={onPayButtonRender:null,onShippingAddressSelectStart:null,onShippingAddressSelectSuccess:null,onShippingAddressSelectError:null,onPaymentSelectStart:null,onPaymentSelectSuccess:null,onPaymentSelectError:null,onCheckoutSubmitChange:null,onXhrResponse:null},_emptyCallback=function(){},_setCheckoutSubmitAllowed=function(e){checkoutSubmitAllowed=e,customCallbacks.onCheckoutSubmitChange&&customCallbacks.onCheckoutSubmitChange(e),_updateCheckoutSubmitButtonState()},_setCheckoutShippingAddressSelected=function(e){checkoutShippingAddressSelected=e,_updateCheckoutSubmitButtonState()},_setCheckoutPaymentSelected=function(e){checkoutPaymentSelected=e,customCallbacks.onPaymentSelect&&customCallbacks.onPaymentSelect(e),_updateCheckoutSubmitButtonState()},_updateCheckoutSubmitButtonState=function(){var e=document.getElementById(config.checkoutSubmitButtonId);e&&(e.disabled=!checkoutSubmitAllowed||!checkoutPaymentSelected||!checkoutShippingAddressSelected)},_handleXhrResponse=function(e){e=JSON.parse(e),e.error&&_handleXhrErrorResponse(e),e.redirect&&(window.location.href=e.redirect),e.render_widget&&(e.render_widget.wallet&&_renderWalletWidget(),e.render_widget["shipping-method"]&&_renderShippingMethod(e.render_widget["shipping-method"]),e.render_widget.review&&_renderReview(e.render_widget.review)),e.disable_widget&&e.disable_widget["address-book"]&&_renderAddressBookWidget("Read"),_setCheckoutSubmitAllowed(e.allow_submit),e.deselect_payment&&_setCheckoutPaymentSelected(!1),customCallbacks.onXhrResponse&&customCallbacks.onXhrResponse(e)},_handleXhrErrorResponse=function(e){e.error_messages&&("object"!=typeof e.error_messages?alert(e.error_messages):alert(e.error_messages.join("\n")))},_getDisplayMode=function(e){return e?e:"Edit"},_renderAddressBookWidget=function(e){return e=_getDisplayMode(e),addressBookWidget=new OffAmazonPayments.Widgets.AddressBook({sellerId:config.merchantId,displayMode:e,onOrderReferenceCreate:"Edit"===e?callbacks.onOrderReferenceCreate:_emptyCallback,amazonOrderReferenceId:checkoutOrderReferenceId,design:checkoutParams.responsive?{designMode:"responsive"}:checkoutParams.addressBook,onAddressSelect:"Edit"===e?callbacks.onAddressSelect:_emptyCallback,onError:callbacks.onWidgetError}),addressBookWidget.bind(checkoutParams.addressBook),this},_renderWalletWidget=function(){var e={sellerId:config.merchantId,onOrderReferenceCreate:callbacks.onOrderReferenceCreate,amazonOrderReferenceId:checkoutOrderReferenceId,design:checkoutParams.responsive?{designMode:"responsive"}:checkoutParams.wallet,onPaymentSelect:callbacks.onPaymentSelect,onError:callbacks.onWidgetError};return config.currency&&(e.presentmentCurrency=config.currency),walletWidget=new OffAmazonPayments.Widgets.Wallet(e),walletWidget.bind(checkoutParams.wallet),this},_renderShippingMethod=function(e){var t=_getElementById(checkoutParams.shippingMethod);if(t){if(t.onchange=callbacks.onShippingMethodSelect,t.innerHTML=e,_evalJsScripts(t),!t.down("input[type=radio]:checked")){var o=t.down("input[type=radio]");o&&(o.checked=!0)}callbacks.onShippingMethodSelect()}return this},_renderReview=function(e){var t=_getElementById(checkoutParams.review);return t&&(t.innerHTML=e,_evalJsScripts(t)),this},saveOrder=function(){_setCheckoutSubmitAllowed(!1),_xhrCall(checkoutParams.urls.saveOrder,_serializeForm(config.checkoutAgreementsFormId,config.shippingMethodFormId,config.simulationFormId,config.customFieldsFormId),callbacks.onXhrSuccess,callbacks.onXhrError,_setFormLoadWaiting,_unsetFormLoadWaiting)},submitCoupon=function(e){_setCheckoutSubmitAllowed(!1),_xhrCall(checkoutParams.urls.saveCoupon,e?_serializeForm(config.discountCouponFormId)+"&remove=1":_serializeForm(config.discountCouponFormId),callbacks.onXhrSuccess,callbacks.onXhrError,function(){_showOverlay(),_setLoadWaiting(checkoutParams.review)},function(){_hideOverlay(),_unsetLoadWaiting(checkoutParams.review)})},initCheckout=function(e){_extendObj(checkoutParams,e),_setCheckoutSubmitAllowed(!1),config.virtual?(_setCheckoutShippingAddressSelected(!0),_renderWalletWidget(),_setCheckoutSubmitAllowed(!0)):(_renderAddressBookWidget(),checkoutOrderReferenceId&&_renderWalletWidget())},initOnepageCheckout=function(e){_extendObj(checkoutParams,e),customCallbacks.onShippingAddressSelectStart=function(){AmazonPaymentsOPC.onShippingAddressSelect(!1,!0)},customCallbacks.onShippingAddressSelectSuccess=function(){AmazonPaymentsOPC.onShippingAddressSelect(!0,!1)},customCallbacks.onShippingAddressSelectError=function(){AmazonPaymentsOPC.onShippingAddressSelect(!1,!1)},customCallbacks.onPaymentSelect=function(e){AmazonPaymentsOPC.onPaymentSelect(e,!1)},customCallbacks.onCheckoutSubmitChange=AmazonPaymentsOPC.onCheckoutSubmitChange,customCallbacks.onXhrResponse=AmazonPaymentsOPC.onXhrResponse,AmazonPaymentsOPC.createContainer(checkoutParams.addressBook,checkoutParams.wallet),_renderAddressBookWidget()},logout=function(){amazon.Login.logout(),Mage.Cookies.clear("amazon_Login_accessToken")},initLogin=function(){return amazon.Login.setClientId(config.clientId),amazon.Login.setUseCookie(!0),this},renderButtons=function(){var e=null;if(config.pay.selector){var t=_getElementsBySelector(config.pay.selector);if(config.pay&&config.pay.callbackUrl)for(var o=0;o<t.length;o++)e=t[o],e&&new OffAmazonPayments.Button(e.id,config.merchantId,{type:e.dataset.buttonType||config.pay.design&&config.pay.design.type||"PwA",size:e.dataset.buttonSize||config.pay.design&&config.pay.design.size||"small",color:e.dataset.buttonColor||config.pay.design&&config.pay.design.color||"Gold",language:config.language,onError:callbacks.onButtonError,authorization:function(){callbacks.authorization(e.dataset.isProductButton)}}),customCallbacks.onPayButtonRender&&customCallbacks.onPayButtonRender(e);else for(var o=0;o<t.length;o++)e=t[o],e&&new OffAmazonPayments.Widgets.Button({sellerId:config.merchantId,useAmazonAddressBook:!config.virtual,onSignIn:callbacks.onSignIn,onError:callbacks.onButtonError}).bind(e.id),customCallbacks.onPayButtonRender&&customCallbacks.onPayButtonRender(e)}if(config.login&&config.login.selector)for(var n=_getElementsBySelector(config.login.selector),o=0;o<n.length;o++)e=n[o],e&&new OffAmazonPayments.Button(e.id,config.merchantId,{type:e.dataset.buttonType||config.login.design&&config.login.design.type||"LwA",size:e.dataset.buttonSize||config.login.design&&config.login.design.size||"small",color:e.dataset.buttonColor||config.login.design&&config.login.design.color||"Gold",language:config.language,onError:callbacks.onButtonError,authorization:function(){amazon.Login.authorize({scope:config.scope,popup:config.popup},config.login.callbackUrl)}});return this},setOrderReferenceId=function(e){return checkoutOrderReferenceId=e,this},setCallbacks=function(e){return _extendObj(customCallbacks,e),this},setup=function(e){return _extendObj(config,e),this};return{setup:setup,setCallbacks:setCallbacks,setOrderReferenceId:setOrderReferenceId,renderButtons:renderButtons,initLogin:initLogin,logout:logout,initCheckout:initCheckout,initOnepageCheckout:initOnepageCheckout,submitCoupon:submitCoupon,saveOrder:saveOrder}}($$,Form.serialize);